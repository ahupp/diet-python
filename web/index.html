<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>diet-python WASM demo</title>
<style>
body { margin:0; height:100vh; display:flex; }
textarea, .CodeMirror { flex:1; font-family: monospace; padding:10px; border:none; height:100%; }
.CodeMirror-readonly { background:#f0f0f0; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css" />
</head>
<body>
<textarea id="input" placeholder="Paste Python code here"></textarea>
<textarea id="output" readonly></textarea>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/python/python.min.js"></script>
<script type="module">
import init, { transform } from "./pkg/diet_python.js";

async function run() {
  await init();
  const input = document.getElementById('input');
  const output = document.getElementById('output');
  const inputEditor = CodeMirror.fromTextArea(input, { lineNumbers: true, mode: 'python' });
  const outputEditor = CodeMirror.fromTextArea(output, { lineNumbers: true, mode: 'python', readOnly: true });
  inputEditor.setSize(null, '100%');
  outputEditor.setSize(null, '100%');
  function update() {
    outputEditor.setValue(transform(inputEditor.getValue()));
    const params = new URLSearchParams(window.location.search);
    const src = inputEditor.getValue();
    if (src) {
      params.set('src', src);
    } else {
      params.delete('src');
    }
    const query = params.toString();
    history.replaceState(null, '', query ? `?${query}` : window.location.pathname);
  }
  const params = new URLSearchParams(window.location.search);
  const initial = params.get('src');
  if (initial !== null) {
    inputEditor.setValue(initial);
  }
  inputEditor.on('change', update);
  update();
}
run();
</script>
</body>
</html>
