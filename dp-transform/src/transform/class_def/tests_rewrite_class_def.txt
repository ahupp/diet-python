$ lowers simple class

class C:
    x = 1
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
    __dp__.setattr(_dp_class_ns, "x", 1)
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ rewrites super without explicit first param

class C:
    def m():
        return super().m()
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def m():
        return getattr$0(super$0(), "m")()

    def _dp_lambda_2():
        return m$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "m", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "m", _dp_lambda_2), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ zero-arg super in __new__ uses defining class helper

class C:
    def __new__(cls, value):
        return super().__new__(cls, value)
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def __new__(cls, value):
        return getattr$0(super$0(), "__new__")(cls, value)

    def _dp_lambda_2():
        return __new__$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__new__", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "__new__", _dp_lambda_2), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ rewrites class del statements

class C:
    x = 1
    del x
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
    __dp__.setattr(_dp_class_ns, "x", 1)
    __dp__.delattr(_dp_class_ns, "x")
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ collects class annotations

class C:
    x: int
    y: str = 1
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_2():
        return __name__$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_2))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def _dp_annotate(_dp_format):
        _dp_target_1 = __dp__.gt(_dp_format, 2)
        if _dp_target_1:

            def _dp_lambda_3():
                return NotImplementedError$0
            _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")
            raise __dp__.class_lookup(_dp_class_ns, "NotImplementedError", _dp_lambda_3)
        _dp_annotations = __dp__.dict()

        def _dp_lambda_4():
            return int$0
        _dp_lambda_4 = __dp__.update_fn(_dp_lambda_4, None, "<lambda>")
        __dp__.setitem(_dp_annotations, "x", __dp__.class_lookup(_dp_class_ns, "int", _dp_lambda_4))

        def _dp_lambda_5():
            return str$0
        _dp_lambda_5 = __dp__.update_fn(_dp_lambda_5, None, "<lambda>")
        __dp__.setitem(_dp_annotations, "y", __dp__.class_lookup(_dp_class_ns, "str", _dp_lambda_5))
        return _dp_annotations
    _dp_annotate = __dp__.update_fn(_dp_annotate, "C", "<locals>")
    __dp__.setattr(_dp_class_ns, "__annotate__", _dp_annotate)
    __dp__.setattr(_dp_class_ns, "y", 1)
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ captures outer reference

class C:
    x = x
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def _dp_lambda_2():
        return x$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "x", __dp__.class_lookup(_dp_class_ns, "x", _dp_lambda_2))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ captures names used in annotations

T = object()

class C:
    x: T
=
T = object()
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_2():
        return __name__$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_2))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def _dp_annotate(_dp_format):
        _dp_target_1 = __dp__.gt(_dp_format, 2)
        if _dp_target_1:

            def _dp_lambda_3():
                return NotImplementedError$0
            _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")
            raise __dp__.class_lookup(_dp_class_ns, "NotImplementedError", _dp_lambda_3)
        _dp_annotations = __dp__.dict()

        def _dp_lambda_4():
            return T$0
        _dp_lambda_4 = __dp__.update_fn(_dp_lambda_4, None, "<lambda>")
        __dp__.setitem(_dp_annotations, "x", __dp__.class_lookup(_dp_class_ns, "T", _dp_lambda_4))
        return _dp_annotations
    _dp_annotate = __dp__.update_fn(_dp_annotate, "C", "<locals>")
    __dp__.setattr(_dp_class_ns, "__annotate__", _dp_annotate)
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ preserves class locals for references

class C:
    x = 1
    y = x
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
    __dp__.setattr(_dp_class_ns, "x", 1)

    def _dp_lambda_2():
        return x$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "y", __dp__.class_lookup(_dp_class_ns, "x", _dp_lambda_2))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ lowers PEP 695 type parameters

class C[T, **P]:
    x: T
=
def _dp_ns_C(_dp_class_ns):
    T = __dp__.type_param_typevar("T", None, None, None)
    P = __dp__.type_param_param_spec("P", None)

    def _dp_lambda_2():
        return __name__$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_2))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
    __dp__.setattr(_dp_class_ns, "__type_params__", (T, P))

    def _dp_annotate(_dp_format):
        _dp_target_1 = __dp__.gt(_dp_format, 2)
        if _dp_target_1:

            def _dp_lambda_3():
                return NotImplementedError$0
            _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")
            raise __dp__.class_lookup(_dp_class_ns, "NotImplementedError", _dp_lambda_3)
        _dp_annotations = __dp__.dict()
        __dp__.setitem(_dp_annotations, "x", T$0)
        return _dp_annotations
    _dp_annotate = __dp__.update_fn(_dp_annotate, "C", "<locals>")
    __dp__.setattr(_dp_class_ns, "__annotate__", _dp_annotate)
C = __dp__.create_class("C", _dp_ns_C, (__dp__.getitem(getattr(__import__("typing"), "Generic"), (T, P)),), None)

$ lowers inherits

class C(B):
    pass
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (B,), None)

$ lowers with docstring and keywords

class C(B, metaclass=Meta, kw=1):
    'doc'
    x = 2
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
    __dp__.setattr(_dp_class_ns, "__doc__", 'doc')
    __dp__.setattr(_dp_class_ns, "x", 2)
C = __dp__.create_class("C", _dp_ns_C, (B,), __dp__.dict((("metaclass", Meta), ("kw", 1))))

$ lowers method

class C:
    def m(self):
        return 1
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def m(self):
        return 1

    def _dp_lambda_2():
        return m$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "m", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "m", _dp_lambda_2), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ method name can be shadowed by locals

class Example:
    def close(self):
        close = self._close
        if close:
            close()
=
def _dp_ns_Example(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "Example")

    def close(self):
        close = self._close
        if close:
            close()

    def _dp_lambda_2():
        return close$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "close", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "close", _dp_lambda_2), "Example", "<locals>"))
Example = __dp__.create_class("Example", _dp_ns_Example, (), None)

$ lowers async method

class C:
    async def m(self):
        return 1
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    async def m(self):
        return 1

    def _dp_lambda_2():
        return m$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "m", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "m", _dp_lambda_2), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ rewrites super and class

class C:
    def m(self):
        return super().m()
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def m(self):
        return getattr$0(super$0(), "m")()

    def _dp_lambda_2():
        return m$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "m", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "m", _dp_lambda_2), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ rewrites super uses first arg

class C:
    def m(z):
        return super().m()
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def m(z):
        return getattr$0(super$0(), "m")()

    def _dp_lambda_2():
        return m$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "m", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "m", _dp_lambda_2), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ rewrites super without receiver

class C:
    def m():
        return super().m()
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def m():
        return getattr$0(super$0(), "m")()

    def _dp_lambda_2():
        return m$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "m", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "m", _dp_lambda_2), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ applies decorators in namespace

class C:
    y = deco

    @decorator(y)
    @other
    def m(self):
        return self
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def _dp_lambda_2():
        return deco$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "y", __dp__.class_lookup(_dp_class_ns, "deco", _dp_lambda_2))

    def m(self):
        return self

    def _dp_lambda_3():
        return m$0
    _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "m", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "m", _dp_lambda_3), "C", "<locals>"))

    def _dp_lambda_4():
        return decorator$0
    _dp_lambda_4 = __dp__.update_fn(_dp_lambda_4, None, "<lambda>")

    def _dp_lambda_5():
        return y$0
    _dp_lambda_5 = __dp__.update_fn(_dp_lambda_5, None, "<lambda>")

    def _dp_lambda_6():
        return other$0
    _dp_lambda_6 = __dp__.update_fn(_dp_lambda_6, None, "<lambda>")

    def _dp_lambda_7():
        return m$0
    _dp_lambda_7 = __dp__.update_fn(_dp_lambda_7, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "m", __dp__.class_lookup(_dp_class_ns, "decorator", _dp_lambda_4)(__dp__.class_lookup(_dp_class_ns, "y", _dp_lambda_5))(__dp__.class_lookup(_dp_class_ns, "other", _dp_lambda_6)(__dp__.class_lookup(_dp_class_ns, "m", _dp_lambda_7))))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ renames class stores and uses

class C:
    a = 1
    b = a

    def f(self, value: b = a):
        return value
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
    __dp__.setattr(_dp_class_ns, "a", 1)

    def _dp_lambda_2():
        return a$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "b", __dp__.class_lookup(_dp_class_ns, "a", _dp_lambda_2))

    def _dp_lambda_3():
        return a$0
    _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")

    def _dp_lambda_4():
        return b$0
    _dp_lambda_4 = __dp__.update_fn(_dp_lambda_4, None, "<lambda>")

    def f(self, value: __dp__.class_lookup(_dp_class_ns, "b", _dp_lambda_4)=__dp__.class_lookup(_dp_class_ns, "a", _dp_lambda_3)):
        return value

    def _dp_lambda_5():
        return f$0
    _dp_lambda_5 = __dp__.update_fn(_dp_lambda_5, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "f", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "f", _dp_lambda_5), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ mangles private class attributes

class C:
    __value = 1

    def read(self):
        return self.__value
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
    __dp__.setattr(_dp_class_ns, "_C__value", 1)

    def read(self):
        return self._C__value

    def _dp_lambda_2():
        return read$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "read", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "read", _dp_lambda_2), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ mangles private attribute access in methods

class C:
    def __value(self):
        return 1

    def read(self):
        return self.__value()
=
def _dp_ns_C(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")

    def _C__value(self):
        return 1

    def _dp_lambda_2():
        return _C__value$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "_C__value", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "_C__value", _dp_lambda_2), "C", "<locals>"))

    def read(self):
        return self._C__value()

    def _dp_lambda_3():
        return read$0
    _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "read", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "read", _dp_lambda_3), "C", "<locals>"))
C = __dp__.create_class("C", _dp_ns_C, (), None)

$ nested class uses outer binding in bases

class Outer:
    x = 1

    class Inner(x):
        pass
=
def _dp_ns_Outer(_dp_class_ns):

    def _dp_lambda_3():
        return __name__$0
    _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_3))
    __dp__.setattr(_dp_class_ns, "__qualname__", "Outer")
    __dp__.setattr(_dp_class_ns, "x", 1)

    def _dp_ns_Inner(_dp_class_ns):

        def _dp_lambda_1():
            return __name__$0
        _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, "Outer", "<lambda>")
        __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
        __dp__.setattr(_dp_class_ns, "__qualname__", "Outer.Inner")
    _dp_ns_Inner = __dp__.update_fn(_dp_ns_Inner, "Outer", "<locals>")

    def _dp_lambda_2():
        return x$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, "Outer", "<locals>")
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, "Outer", "<lambda>")
    __dp__.setattr(_dp_class_ns, "Inner", __dp__.create_class("Inner", _dp_ns_Inner, (__dp__.class_lookup(_dp_class_ns, "x", _dp_lambda_2),), None))
Outer = __dp__.create_class("Outer", _dp_ns_Outer, (), None)

$ function local class remains scoped

class Example:
    def trigger(self):
        class Token:
            pass
        return Token
=
def _dp_ns_Example(_dp_class_ns):

    def _dp_lambda_3():
        return __name__$0
    _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_3))
    __dp__.setattr(_dp_class_ns, "__qualname__", "Example")

    def trigger(self):

        def _dp_ns_Token(_dp_class_ns):

            def _dp_lambda_2():
                return __name__$0
            _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, "Example.trigger.<locals>", "<lambda>")
            __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_2))
            __dp__.setattr(_dp_class_ns, "__qualname__", "Example.trigger.<locals>.Token")
        Token = __dp__.create_class("Token", _dp_ns_Token, (), None)
        return Token

    def _dp_lambda_4():
        return trigger$0
    _dp_lambda_4 = __dp__.update_fn(_dp_lambda_4, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "trigger", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "trigger", _dp_lambda_4), "Example", "<locals>"))
Example = __dp__.create_class("Example", _dp_ns_Example, (), None)

$ function local class nested in if

class Example:
    def trigger(self, flag):
        if flag:
            class Token:
                pass
            return Token
        return None
=
def _dp_ns_Example(_dp_class_ns):

    def _dp_lambda_3():
        return __name__$0
    _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_3))
    __dp__.setattr(_dp_class_ns, "__qualname__", "Example")

    def trigger(self, flag):
        if flag:

            def _dp_ns_Token(_dp_class_ns):

                def _dp_lambda_2():
                    return __name__$0
                _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, "Example.trigger.<locals>", "<lambda>")
                __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_2))
                __dp__.setattr(_dp_class_ns, "__qualname__", "Example.trigger.<locals>.Token")
            Token = __dp__.create_class("Token", _dp_ns_Token, (), None)
            return Token
        return None

    def _dp_lambda_4():
        return trigger$0
    _dp_lambda_4 = __dp__.update_fn(_dp_lambda_4, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "trigger", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "trigger", _dp_lambda_4), "Example", "<locals>"))
Example = __dp__.create_class("Example", _dp_ns_Example, (), None)

$ function local methods capture locals

def outer():
    value = 1

    class C:
        def method(self):
            return value

    return C
=
def outer():
    value = 1

    def _dp_ns_C(_dp_class_ns):

        def _dp_lambda_1():
            return __name__$0
        _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, "outer.<locals>", "<lambda>")
        __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
        __dp__.setattr(_dp_class_ns, "__qualname__", "outer.<locals>.C")

        def method(self):
            return value$1

        def _dp_lambda_2():
            return method$0
        _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, "outer.<locals>", "<lambda>")
        __dp__.setattr(_dp_class_ns, "method", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "method", _dp_lambda_2), "outer.<locals>.C", "<locals>"))
    C = __dp__.create_class("C", _dp_ns_C, (), None)
    return C

$ class scope combinations

results = {}

x = "global"
class C1:
    x = "class"
    def read():
        return x
results["class_attr_vs_global"] = (C1.x, C1.read(), x)

x = "module"
class C2:
    global x
    x = "class-global"
    y = "class-attr"
results["class_global_assignment"] = (x, getattr(C2, "x", None), C2.y)

x = "module"
class C3:
    def set_x():
        global x
        x = "method-global"
    def read_x():
        return x
C3.set_x()
results["class_method_global_assignment"] = (x, C3.read_x())

class C4:
    def outer():
        x = "outer"
        def inner():
            nonlocal x
            x = "inner"
        inner()
        return x
results["class_method_nonlocal_inner"] = C4.outer()

def outer_with_inner_class():
    x = "outer"
    class Inner:
        y = x
    return Inner.y
results["def_with_inner_class_capture"] = outer_with_inner_class()

x = "module"
def outer_with_inner_class_global_assignment():
    x = "outer"
    class Inner:
        global x
        x = "class-global"
        y = "class-attr"
    return (x, getattr(Inner, "x", None), Inner.y)
results["def_with_inner_class_global_assignment"] = (outer_with_inner_class_global_assignment(), x)

x = "module"
def outer_with_class_method_reads_global():
    x = "outer"
    class Inner:
        x = "class"
        def read():
            return x
    return (Inner.x, Inner.read(), x)
results["def_with_class_with_method_reads_global"] = outer_with_class_method_reads_global()

def outer_with_nonlocal_and_inner_class():
    x = "outer"
    def inner():
        nonlocal x
        x = "inner"
        class Inner:
            y = x
        return Inner.y
    y = inner()
    return (x, y)
results["def_with_nonlocal_and_inner_class"] = outer_with_nonlocal_and_inner_class()

def nonlocal_in_class_body_error():
    try:
        exec("class Bad:\\n    nonlocal x\\n")
    except SyntaxError as exc:
        return exc.msg
    return None
results["class_nonlocal_syntaxerror"] = nonlocal_in_class_body_error()
=
results = __dp__.dict()
x = "global"
def _dp_ns_C1(_dp_class_ns):

    def _dp_lambda_1():
        return __name__$0
    _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C1")
    __dp__.setattr(_dp_class_ns, "x", "class")

    def read():
        return x$0

    def _dp_lambda_2():
        return read$0
    _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "read", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "read", _dp_lambda_2), "C1", "<locals>"))
C1 = __dp__.create_class("C1", _dp_ns_C1, (), None)
__dp__.setitem(results, "class_attr_vs_global", (C1.x, C1.read(), x))
x = "module"
def _dp_ns_C2(_dp_class_ns):

    def _dp_lambda_3():
        return __name__$0
    _dp_lambda_3 = __dp__.update_fn(_dp_lambda_3, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_3))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C2")
    x$0 = "class-global"
    __dp__.setattr(_dp_class_ns, "y", "class-attr")
C2 = __dp__.create_class("C2", _dp_ns_C2, (), None)
__dp__.setitem(results, "class_global_assignment", (x, getattr(C2, "x", None), C2.y))
x = "module"
def _dp_ns_C3(_dp_class_ns):

    def _dp_lambda_4():
        return __name__$0
    _dp_lambda_4 = __dp__.update_fn(_dp_lambda_4, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_4))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C3")

    def set_x():
        x$0 = "method-global"

    def _dp_lambda_5():
        return set_x$0
    _dp_lambda_5 = __dp__.update_fn(_dp_lambda_5, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "set_x", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "set_x", _dp_lambda_5), "C3", "<locals>"))

    def read_x():
        return x$0

    def _dp_lambda_6():
        return read_x$0
    _dp_lambda_6 = __dp__.update_fn(_dp_lambda_6, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "read_x", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "read_x", _dp_lambda_6), "C3", "<locals>"))
C3 = __dp__.create_class("C3", _dp_ns_C3, (), None)
C3.set_x()
__dp__.setitem(results, "class_method_global_assignment", (x, C3.read_x()))
def _dp_ns_C4(_dp_class_ns):

    def _dp_lambda_7():
        return __name__$0
    _dp_lambda_7 = __dp__.update_fn(_dp_lambda_7, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_7))
    __dp__.setattr(_dp_class_ns, "__qualname__", "C4")

    def outer():
        x = "outer"

        def inner():
            x$1 = "inner"
        inner()
        return x

    def _dp_lambda_8():
        return outer$0
    _dp_lambda_8 = __dp__.update_fn(_dp_lambda_8, None, "<lambda>")
    __dp__.setattr(_dp_class_ns, "outer", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "outer", _dp_lambda_8), "C4", "<locals>"))
C4 = __dp__.create_class("C4", _dp_ns_C4, (), None)
__dp__.setitem(results, "class_method_nonlocal_inner", C4.outer())
def outer_with_inner_class():
    x = "outer"

    def _dp_ns_Inner(_dp_class_ns):

        def _dp_lambda_9():
            return __name__$0
        _dp_lambda_9 = __dp__.update_fn(_dp_lambda_9, "outer_with_inner_class.<locals>", "<lambda>")
        __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_9))
        __dp__.setattr(_dp_class_ns, "__qualname__", "outer_with_inner_class.<locals>.Inner")

        def _dp_lambda_10():
            return x$1
        _dp_lambda_10 = __dp__.update_fn(_dp_lambda_10, "outer_with_inner_class.<locals>", "<lambda>")
        __dp__.setattr(_dp_class_ns, "y", __dp__.class_lookup(_dp_class_ns, "x", _dp_lambda_10))
    Inner = __dp__.create_class("Inner", _dp_ns_Inner, (), None)
    return Inner.y
__dp__.setitem(results, "def_with_inner_class_capture", outer_with_inner_class())
x = "module"
def outer_with_inner_class_global_assignment():
    x = "outer"

    def _dp_ns_Inner(_dp_class_ns):

        def _dp_lambda_11():
            return __name__$0
        _dp_lambda_11 = __dp__.update_fn(_dp_lambda_11, "outer_with_inner_class_global_assignment.<locals>", "<lambda>")
        __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_11))
        __dp__.setattr(_dp_class_ns, "__qualname__", "outer_with_inner_class_global_assignment.<locals>.Inner")
        x$0 = "class-global"
        __dp__.setattr(_dp_class_ns, "y", "class-attr")
    Inner = __dp__.create_class("Inner", _dp_ns_Inner, (), None)
    return x, getattr$0(Inner, "x", None), Inner.y
__dp__.setitem(results, "def_with_inner_class_global_assignment", (outer_with_inner_class_global_assignment(), x))
x = "module"
def outer_with_class_method_reads_global():
    x = "outer"

    def _dp_ns_Inner(_dp_class_ns):

        def _dp_lambda_12():
            return __name__$0
        _dp_lambda_12 = __dp__.update_fn(_dp_lambda_12, "outer_with_class_method_reads_global.<locals>", "<lambda>")
        __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_12))
        __dp__.setattr(_dp_class_ns, "__qualname__", "outer_with_class_method_reads_global.<locals>.Inner")
        __dp__.setattr(_dp_class_ns, "x", "class")

        def read():
            return x$1

        def _dp_lambda_13():
            return read$0
        _dp_lambda_13 = __dp__.update_fn(_dp_lambda_13, "outer_with_class_method_reads_global.<locals>", "<lambda>")
        __dp__.setattr(_dp_class_ns, "read", __dp__.update_fn(__dp__.class_lookup(_dp_class_ns, "read", _dp_lambda_13), "outer_with_class_method_reads_global.<locals>.Inner", "<locals>"))
    Inner = __dp__.create_class("Inner", _dp_ns_Inner, (), None)
    return Inner.x, Inner.read(), x
__dp__.setitem(results, "def_with_class_with_method_reads_global", outer_with_class_method_reads_global())
def outer_with_nonlocal_and_inner_class():
    x = "outer"

    def inner():
        x$1 = "inner"

        def _dp_ns_Inner(_dp_class_ns):

            def _dp_lambda_14():
                return __name__$0
            _dp_lambda_14 = __dp__.update_fn(_dp_lambda_14, "outer_with_nonlocal_and_inner_class.<locals>.inner.<locals>", "<lambda>")
            __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_14))
            __dp__.setattr(_dp_class_ns, "__qualname__", "outer_with_nonlocal_and_inner_class.<locals>.inner.<locals>.Inner")

            def _dp_lambda_15():
                return x$1
            _dp_lambda_15 = __dp__.update_fn(_dp_lambda_15, "outer_with_nonlocal_and_inner_class.<locals>.inner.<locals>", "<lambda>")
            __dp__.setattr(_dp_class_ns, "y", __dp__.class_lookup(_dp_class_ns, "x", _dp_lambda_15))
        Inner = __dp__.create_class("Inner", _dp_ns_Inner, (), None)
        return Inner.y
    y = inner()
    return x, y
__dp__.setitem(results, "def_with_nonlocal_and_inner_class", outer_with_nonlocal_and_inner_class())
def nonlocal_in_class_body_error():
    try:
        exec$0("class Bad:\\n    nonlocal x\\n")
    except:
        if __dp__.exception_matches(__dp__.current_exception(), SyntaxError$0):
            exc = __dp__.current_exception()
            try:
                return exc.msg
            finally:
                try:
                    del exc
                except:
                    if __dp__.exception_matches(__dp__.current_exception(), NameError$0):
                        pass
                    else:
                        raise
        else:
            raise
    return None
__dp__.setitem(results, "class_nonlocal_syntaxerror", nonlocal_in_class_body_error())

$ class body captures non-immediate enclosing locals

def outer():
    value = 1

    def inner():
        class C:
            x = value
        return C

    return inner()
=
def outer():
    value = 1

    def inner():

        def _dp_ns_C(_dp_class_ns):

            def _dp_lambda_1():
                return __name__$0
            _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, "outer.<locals>.inner.<locals>", "<lambda>")
            __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
            __dp__.setattr(_dp_class_ns, "__qualname__", "outer.<locals>.inner.<locals>.C")

            def _dp_lambda_2():
                return value$1
            _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, "outer.<locals>.inner.<locals>", "<lambda>")
            __dp__.setattr(_dp_class_ns, "x", __dp__.class_lookup(_dp_class_ns, "value", _dp_lambda_2))
        C = __dp__.create_class("C", _dp_ns_C, (), None)
        return C
    return inner()

$ class locals shadow enclosing locals

def outer():
    value = 1

    class C:
        x = value
        value = 2

    return C
=
def outer():
    value = 1

    def _dp_ns_C(_dp_class_ns):

        def _dp_lambda_1():
            return __name__$0
        _dp_lambda_1 = __dp__.update_fn(_dp_lambda_1, "outer.<locals>", "<lambda>")
        __dp__.setattr(_dp_class_ns, "__module__", __dp__.class_lookup(_dp_class_ns, "__name__", _dp_lambda_1))
        __dp__.setattr(_dp_class_ns, "__qualname__", "outer.<locals>.C")

        def _dp_lambda_2():
            return value$1
        _dp_lambda_2 = __dp__.update_fn(_dp_lambda_2, "outer.<locals>", "<lambda>")
        __dp__.setattr(_dp_class_ns, "x", __dp__.class_lookup(_dp_class_ns, "value", _dp_lambda_2))
        __dp__.setattr(_dp_class_ns, "value", 2)
    C = __dp__.create_class("C", _dp_ns_C, (), None)
    return C
