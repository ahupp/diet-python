$ rewrites with statement

with a as b:
    c
=
_dp_with_ctx_1 = a
try:
    _dp_with_enter_2 = _dp_with_ctx_1.__enter__
except:
    if __dp__.exception_matches(__dp__.current_exception(), AttributeError):
        _dp_with_exc = __dp__.current_exception()
        try:
            raise __dp__.raise_from(TypeError("the context manager protocol requires __enter__"), _dp_with_exc)
        finally:
            try:
                del _dp_with_exc
            except:
                if __dp__.exception_matches(__dp__.current_exception(), NameError):
                    pass
                else:
                    raise
    else:
        raise
try:
    _dp_with_exit_3 = _dp_with_ctx_1.__exit__
except:
    if __dp__.exception_matches(__dp__.current_exception(), AttributeError):
        _dp_with_exc = __dp__.current_exception()
        try:
            raise __dp__.raise_from(TypeError("the context manager protocol requires __exit__"), _dp_with_exc)
        finally:
            try:
                del _dp_with_exc
            except:
                if __dp__.exception_matches(__dp__.current_exception(), NameError):
                    pass
                else:
                    raise
    else:
        raise
b = _dp_with_enter_2()
_dp_with_active_4 = True
try:
    c
except:
    _dp_with_active_4 = False
    __dp__.with_exit(_dp_with_exit_3, __dp__.exc_info())
finally:
    if _dp_with_active_4:
        __dp__.with_exit(_dp_with_exit_3, None)
    _dp_with_exit_3 = None
    _dp_with_enter_2 = None
    _dp_with_ctx_1 = None

$ rewrites multiple with statement

with a as b, c as d:
    e
=
_dp_with_ctx_5 = a
try:
    _dp_with_enter_6 = _dp_with_ctx_5.__enter__
except:
    if __dp__.exception_matches(__dp__.current_exception(), AttributeError):
        _dp_with_exc = __dp__.current_exception()
        try:
            raise __dp__.raise_from(TypeError("the context manager protocol requires __enter__"), _dp_with_exc)
        finally:
            try:
                del _dp_with_exc
            except:
                if __dp__.exception_matches(__dp__.current_exception(), NameError):
                    pass
                else:
                    raise
    else:
        raise
try:
    _dp_with_exit_7 = _dp_with_ctx_5.__exit__
except:
    if __dp__.exception_matches(__dp__.current_exception(), AttributeError):
        _dp_with_exc = __dp__.current_exception()
        try:
            raise __dp__.raise_from(TypeError("the context manager protocol requires __exit__"), _dp_with_exc)
        finally:
            try:
                del _dp_with_exc
            except:
                if __dp__.exception_matches(__dp__.current_exception(), NameError):
                    pass
                else:
                    raise
    else:
        raise
b = _dp_with_enter_6()
_dp_with_active_8 = True
try:
    _dp_with_ctx_1 = c
    try:
        _dp_with_enter_2 = _dp_with_ctx_1.__enter__
    except:
        if __dp__.exception_matches(__dp__.current_exception(), AttributeError):
            _dp_with_exc = __dp__.current_exception()
            try:
                raise __dp__.raise_from(TypeError("the context manager protocol requires __enter__"), _dp_with_exc)
            finally:
                try:
                    del _dp_with_exc
                except:
                    if __dp__.exception_matches(__dp__.current_exception(), NameError):
                        pass
                    else:
                        raise
        else:
            raise
    try:
        _dp_with_exit_3 = _dp_with_ctx_1.__exit__
    except:
        if __dp__.exception_matches(__dp__.current_exception(), AttributeError):
            _dp_with_exc = __dp__.current_exception()
            try:
                raise __dp__.raise_from(TypeError("the context manager protocol requires __exit__"), _dp_with_exc)
            finally:
                try:
                    del _dp_with_exc
                except:
                    if __dp__.exception_matches(__dp__.current_exception(), NameError):
                        pass
                    else:
                        raise
        else:
            raise
    d = _dp_with_enter_2()
    _dp_with_active_4 = True
    try:
        e
    except:
        _dp_with_active_4 = False
        __dp__.with_exit(_dp_with_exit_3, __dp__.exc_info())
    finally:
        if _dp_with_active_4:
            __dp__.with_exit(_dp_with_exit_3, None)
        _dp_with_exit_3 = None
        _dp_with_enter_2 = None
        _dp_with_ctx_1 = None
except:
    _dp_with_active_8 = False
    __dp__.with_exit(_dp_with_exit_7, __dp__.exc_info())
finally:
    if _dp_with_active_8:
        __dp__.with_exit(_dp_with_exit_7, None)
    _dp_with_exit_7 = None
    _dp_with_enter_6 = None
    _dp_with_ctx_5 = None

$ rewrites async with statement

async def f():
    async with a as b:
        c
=
async def _dp_fn_f():
    _dp_with_enter_2 = await __dp__.with_aenter(a$0)
    b = __dp__.getitem(_dp_with_enter_2, 0)
    _dp_with_exit_3 = __dp__.getitem(_dp_with_enter_2, 1)
    _dp_with_active_4 = True
    try:
        c$0
    except:
        _dp_with_active_4 = False
        await __dp__.with_aexit(_dp_with_exit_3, __dp__.exc_info())
    finally:
        if _dp_with_active_4:
            await __dp__.with_aexit(_dp_with_exit_3, None)
        _dp_with_exit_3 = None
        _dp_with_enter_2 = None
f = __dp__.update_fn(_dp_fn_f, None, "f")
del _dp_fn_f

$ rewrites with starred target

with a as (b, *c):
    pass
=
_dp_with_ctx_1 = a
try:
    _dp_with_enter_2 = _dp_with_ctx_1.__enter__
except:
    if __dp__.exception_matches(__dp__.current_exception(), AttributeError):
        _dp_with_exc = __dp__.current_exception()
        try:
            raise __dp__.raise_from(TypeError("the context manager protocol requires __enter__"), _dp_with_exc)
        finally:
            try:
                del _dp_with_exc
            except:
                if __dp__.exception_matches(__dp__.current_exception(), NameError):
                    pass
                else:
                    raise
    else:
        raise
try:
    _dp_with_exit_3 = _dp_with_ctx_1.__exit__
except:
    if __dp__.exception_matches(__dp__.current_exception(), AttributeError):
        _dp_with_exc = __dp__.current_exception()
        try:
            raise __dp__.raise_from(TypeError("the context manager protocol requires __exit__"), _dp_with_exc)
        finally:
            try:
                del _dp_with_exc
            except:
                if __dp__.exception_matches(__dp__.current_exception(), NameError):
                    pass
                else:
                    raise
    else:
        raise
_dp_tmp_5 = _dp_with_enter_2()
try:
    _dp_tmp_6 = __dp__.unpack(_dp_tmp_5, (True, False))
    b = __dp__.getitem(_dp_tmp_6, 0)
    c = __dp__.list(__dp__.getitem(_dp_tmp_6, 1))
finally:
    _dp_tmp_6 = None
    _dp_tmp_5 = None
_dp_with_active_4 = True
try:
    pass
except:
    _dp_with_active_4 = False
    __dp__.with_exit(_dp_with_exit_3, __dp__.exc_info())
finally:
    if _dp_with_active_4:
        __dp__.with_exit(_dp_with_exit_3, None)
    _dp_with_exit_3 = None
    _dp_with_enter_2 = None
    _dp_with_ctx_1 = None
