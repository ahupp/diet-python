$ lowers simple class

class C:
    x = 1
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "x", 1)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ rewrites class del statements

class C:
    x = 1
    del x
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "x", 1)
    __dp__.delattr(_dp_class_ns, "x")
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ collects class annotations

class C:
    x: int
    y: str = 1
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "y", 1)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
    _dp_class_annotations = _dp_class_ns.get("__annotations__")
    _dp_tmp_1 = __dp__.is_(_dp_class_annotations, None)
    if _dp_tmp_1:
        _dp_class_annotations = __dp__.dict()
    __dp__.setattr(_dp_class_ns, "__annotations__", _dp_class_annotations)
    __dp__.setitem(_dp_class_annotations, "x", int)
    __dp__.setitem(_dp_class_annotations, "y", str)
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ captures outer reference

class C:
    x = x
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "x", x)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ captures names used in annotations

T = object()

class C:
    x: T
=
T = object()
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
    _dp_class_annotations = _dp_class_ns.get("__annotations__")
    _dp_tmp_1 = __dp__.is_(_dp_class_annotations, None)
    if _dp_tmp_1:
        _dp_class_annotations = __dp__.dict()
    __dp__.setattr(_dp_class_ns, "__annotations__", _dp_class_annotations)
    __dp__.setitem(_dp_class_annotations, "x", T)
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ preserves class locals for references

class C:
    x = 1
    y = x
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "x", 1)
    __dp__.setattr(_dp_class_ns, "y", _dp_class_ns.x)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ lowers inherits

class C(B):
    pass
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (B,), None)
del _dp_ns_C
$ lowers with docstring and keywords

class C(B, metaclass=Meta, kw=1):
    'doc'
    x = 2
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "__doc__", 'doc')
    __dp__.setattr(_dp_class_ns, "x", 2)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (B,), __dp__.dict((("metaclass", Meta), ("kw", 1))))
del _dp_ns_C
$ lowers method

class C:
    def m(self):
        return 1
=
def _dp_ns_C(_dp_class_ns):

    def m(self):
        return 1
    __dp__.setattr(_dp_class_ns, "m", m)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ lowers async method

class C:
    async def m(self):
        return 1
=
def _dp_ns_C(_dp_class_ns):

    async def m(self):
        return 1
    __dp__.setattr(_dp_class_ns, "m", m)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ rewrites super and class

class C:
    def m(self):
        return super().m()
=
def _dp_ns_C(_dp_class_ns):

    def m(self):
        return super(C, self).m()
    __dp__.setattr(_dp_class_ns, "m", m)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ rewrites super uses first arg

class C:
    def m(z):
        return super().m()
=
def _dp_ns_C(_dp_class_ns):

    def m(z):
        return super(C, z).m()
    __dp__.setattr(_dp_class_ns, "m", m)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ rewrites super without receiver

class C:
    def m():
        return super().m()
=
def _dp_ns_C(_dp_class_ns):

    def m():
        return super(C, None).m()
    __dp__.setattr(_dp_class_ns, "m", m)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ applies decorators in namespace

class C:
    y = deco

    @decorator(y)
    @other
    def m(self):
        return self
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "y", deco)
    _dp_tmp_1 = decorator(_dp_class_ns.y)

    def m(self):
        return self
    __dp__.setattr(_dp_class_ns, "m", m)
    __dp__.setattr(_dp_class_ns, "m", _dp_tmp_1(other(_dp_class_ns.m)))
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ renames class stores and uses

class C:
    a = 1
    b = a

    def f(self, value: b = a):
        return value
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "a", 1)
    __dp__.setattr(_dp_class_ns, "b", _dp_class_ns.a)

    def f(self, value: _dp_class_ns.b=_dp_class_ns.a):
        return value
    __dp__.setattr(_dp_class_ns, "f", f)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ mangles private class attributes

class C:
    __value = 1

    def read(self):
        return __value
=
def _dp_ns_C(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "_C__value", 1)

    def read(self):
        return _dp_class_ns._C__value
    __dp__.setattr(_dp_class_ns, "read", read)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "C")
C = __dp__.create_class("C", _dp_ns_C, (), None)
del _dp_ns_C
$ nested class uses outer binding in bases

class Outer:
    x = 1

    class Inner(x):
        pass
=
def _dp_ns_Outer(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "x", 1)
    __dp__.setattr(_dp_class_ns, "Inner", __dp__.create_class("Inner", _dp_ns_Outer_Inner, (_dp_class_ns.x,), None))
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "Outer")
def _dp_ns_Outer_Inner(_dp_class_ns):
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "Outer.Inner")
Outer = __dp__.create_class("Outer", _dp_ns_Outer, (), None)
del _dp_ns_Outer_Inner
del _dp_ns_Outer
$ function local class remains scoped

class Example:
    def trigger(self):
        class Token:
            pass
        return Token
=
def _dp_ns_Example(_dp_class_ns):

    def trigger(self):

        def _dp_ns_trigger__locals__Token(_dp_class_ns):
            __dp__.setattr(_dp_class_ns, "__module__", __name__)
            __dp__.setattr(_dp_class_ns, "__qualname__", "trigger.<locals>.Token")
        Token = __dp__.create_class("Token", _dp_ns_trigger__locals__Token, (), None)
        del _dp_ns_trigger__locals__Token
        return Token
    __dp__.setattr(_dp_class_ns, "trigger", trigger)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "Example")
Example = __dp__.create_class("Example", _dp_ns_Example, (), None)
del _dp_ns_Example
$ function local class nested in if

class Example:
    def trigger(self, flag):
        if flag:
            class Token:
                pass
            return Token
        return None
=
def _dp_ns_Example(_dp_class_ns):

    def trigger(self, flag):
        if flag:

            def _dp_ns_trigger__locals__Token(_dp_class_ns):
                __dp__.setattr(_dp_class_ns, "__module__", __name__)
                __dp__.setattr(_dp_class_ns, "__qualname__", "trigger.<locals>.Token")
            Token = __dp__.create_class("Token", _dp_ns_trigger__locals__Token, (), None)
            del _dp_ns_trigger__locals__Token
            return Token
        return None
    __dp__.setattr(_dp_class_ns, "trigger", trigger)
    __dp__.setattr(_dp_class_ns, "__module__", __name__)
    __dp__.setattr(_dp_class_ns, "__qualname__", "Example")
Example = __dp__.create_class("Example", _dp_ns_Example, (), None)
del _dp_ns_Example
$ function local methods capture locals

def outer():
    value = 1

    class C:
        def method(self):
            return value

    return C
=
def outer():
    value = 1

    def _dp_ns_outer__locals__C(_dp_class_ns):

        def method(self):
            return value
        __dp__.setattr(_dp_class_ns, "method", method)
        __dp__.setattr(_dp_class_ns, "__module__", __name__)
        __dp__.setattr(_dp_class_ns, "__qualname__", "outer.<locals>.C")
    C = __dp__.create_class("C", _dp_ns_outer__locals__C, (), None)
    del _dp_ns_outer__locals__C
    return C
